var express=require("express"),app=express(),server=require("http").createServer(app),io=require("socket.io",{rememberTransport:!1,transports:["WebSocket","Flash Socket","AJAX long-polling"]}).listen(server),players={},bullets={},coopPlayers={};server.listen(process.env.PORT||5e3),app.use(express.static(__dirname+"/")),app.get("/",function(e,o){o.sendfile(__dirname+"/index.html")}),io.sockets.on("connection",function(e){function o(o){var s=JSON.parse(o),n={};n.sessionID=s.player,n.x=s.x,n.y=s.y,n.angle=s.angle,n.minion=!1,players[n.sessionID]=n,e.broadcast.emit("updatePos",players)}var s=e.handshake.address.address,n=e.handshake.address.remoteAddress;console.log("ip address: ",s),console.log("remote ip: ",n),e.on("requestPlayers",function(e){io.sockets.socket(e).emit("onlinePlayer",players),io.sockets.socket(e).emit("onlineCoop",coopPlayers)}),e.on("newPlayer",function(o){var s=JSON.parse(o),n=s.sessionid,a=s.nickname,r=s.x,i=s.y,t=s.lat,l=s.long,p=s.angle;"undefined"==typeof t&&(t=0),"undefined"==typeof l&&(l=0);var c={};c.session=n,c.nickname=a,c.x=r,c.y=i,c.angle=p,c.lat=t,c.long=l,players[c.session]=c,e.broadcast.emit("sendNewPlayer",players[c.session])}),e.on("newCoop",function(o){var s=JSON.parse(o),n=s.player1,a=s.player2,r=n+a,i=s.shoot,t=s.move,l={};l.session=r,l.player2=n,l.player1=a,l.shoot=i,l.move=t,l.x=s.x,l.y=s.y,l.angle=s.angle,coopPlayers[l.session]=l,players[n].coop=!0,players[a].coop=!0,e.broadcast.emit("joinCoop",o)}),e.on("getCoopPlayers",function(e){var o={};for(var s in players)0!==Object.getOwnPropertyNames(coopPlayers).length?Object.keys(coopPlayers).forEach(function(e){e.indexOf(s)>-1?console.log("IS IN COOP MODE",s):(console.log("not in coop mode",s),o[s]=players[s])}):o[s]=players[s];console.log("alle NIET coop players",o),0!==Object.getOwnPropertyNames(o).length&&io.sockets.socket(e).emit("notCoop",o)}),e.on("newPos",function(e){o(e)}),e.on("damagePlayer",function(e){io.sockets.emit("playerShot",e)}),e.on("bossDied",function(o){e.broadcast.emit("bossDead",o)}),e.on("positionChange",function(o){var s=JSON.parse(o),n=s.sessionid,a=s.nickname,r=s.x,i=s.y,t=s.angle,l={};l.session=n,l.nickname=a,l.x=r,l.y=i,l.angle=t,players[l.session]=l,e.broadcast.emit("updatePlayer",players[l.session])}),e.on("locationUpdate",function(o){var s=JSON.parse(o);"undefined"!=typeof s&&"undefined"!=typeof players[s.sessionid]&&(""!==s.lat&&(players[s.sessionid].lat=s.lat),""!==s.long&&(players[s.sessionid].long=s.long),e.broadcast.emit("updatedLocation",players[s.sessionid]))}),e.on("bulletChange",function(e){var o=JSON.parse(e),s={};s.session=o.sessionid,s.nickname=o.nickname,s.resetX=o.resetX,s.resetY=o.resetY,s.bulletY=o.bulletY,s.rotation=o.rotation,s.randVelocity=o.randVelocity,bullets[s.session]=s,io.sockets.emit("newBullet",bullets[s.session])}),e.on("playerDied",function(e){console.log("Removed dead player: ",e)}),e.on("playerMinion",function(e){players[e].minion=!0,io.sockets.emit("minionPlayer",e)}),e.on("disconnect",function(){delete players[e.id],e.broadcast.emit("removePlayer",e.id),console.log("player deleted: ",e.id)})});