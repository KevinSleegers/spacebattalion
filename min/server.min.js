var express=require("express"),app=express(),server=require("http").createServer(app),io=require("socket.io",{rememberTransport:!1,transports:["WebSocket","Flash Socket","AJAX long-polling"]}).listen(server),players={},bullets={},coopPlayers={},room="",rooms={},maxPlayers=3;skins={},tints={},server.listen(process.env.PORT||5e3),app.use(express.static(__dirname+"/")),app.get("/",function(e,s){s.sendfile(__dirname+"/index.html")}),io.sockets.on("connection",function(e){function s(e){for(var s="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;e>n;n++)s+=o.charAt(Math.floor(Math.random()*o.length));return s}e.emit("rooms",rooms),e.on("requestPlayers",function(s,o){var n={},i=io.sockets.clients(o);i.forEach(function(s){s.session!==e.id&&(n[s.session]=players[s.session])}),io.sockets.socket(e.id).emit("onlinePlayer",n)}),e.on("newPlayer",function(s,o){var n=o,i=JSON.parse(s),t=i.sessionid,a=i.nickname,r=i.x,l=i.y,c=i.lat,p=i.long,d=i.angle,m=i.isboss;"undefined"==typeof c&&(c=0),"undefined"==typeof p&&(p=0);var y={};y.session=t,y.nickname=a,y.x=r,y.y=l,y.angle=d,y.lat=c,y.long=p,y.boss=m,0!==Object.getOwnPropertyNames(skins).length?Object.keys(skins).forEach(function(e){y.skin=e.indexOf(i.sessionid)>-1?skins[i.sessionid]:0}):y.skin=0,0!==Object.getOwnPropertyNames(tints).length?Object.keys(tints).forEach(function(e){y.tint=e.indexOf(i.sessionid)>-1?tints[i.sessionid]:0}):y.tint=0,players[y.session]=y,e.broadcast.to(n).emit("sendNewPlayer",players[y.session])}),e.on("newCoop",function(s,o){var n=o,i=JSON.parse(s),t=i.player1,a=i.player2,r=t+a,l=i.shoot,c=i.move,p={};p.session=r,p.player2=t,p.player1=a,p.shoot=l,p.move=c,p.x=i.x,p.y=i.y,p.angle=i.angle,coopPlayers[p.session]=p,players[t].coop=!0,players[a].coop=!0,e.broadcast.to(n).emit("joinCoop",s)}),e.on("getCoopPlayers",function(e){var s={};for(var o in players)0!==Object.getOwnPropertyNames(coopPlayers).length?Object.keys(coopPlayers).forEach(function(e){e.indexOf(o)>-1?console.log("IS IN COOP MODE",o):(console.log("not in coop mode",o),s[o]=players[o])}):s[o]=players[o];0!==Object.getOwnPropertyNames(s).length&&io.sockets.socket(e).emit("notCoop",s)}),e.on("damagePlayer",function(e,s){var o=s;io.sockets.in(o).emit("playerShot",e)}),e.on("bossDied",function(e,s){var o=s;io.sockets.in(o).emit("bossDead",e)}),e.on("positionChange",function(s,o){var n=o,i=JSON.parse(s),t=i.sessionid,a=i.nickname,r=i.x,l=i.y,c=i.angle,p=i.isboss,d={};d.session=t,d.nickname=a,d.x=r,d.y=l,d.angle=c,d.b=c,d.boss=p,0!==Object.getOwnPropertyNames(skins).length?Object.keys(skins).forEach(function(e){d.skin=e.indexOf(i.sessionid)>-1?skins[i.sessionid]:0}):d.skin=0,players[d.session]=d,e.broadcast.to(n).emit("updatePlayer",players[d.session])}),e.on("locationUpdate",function(s,o){var n=o,i=JSON.parse(s);"undefined"!=typeof i&&"undefined"!=typeof players[i.sessionid]&&(""!==i.lat&&(players[i.sessionid].lat=i.lat),""!==i.long&&(players[i.sessionid].long=i.long),e.broadcast.to(n).emit("updatedLocation",players[i.sessionid]))}),e.on("bulletChange",function(e,s){var o=s,n=JSON.parse(e),i={};i.session=n.sessionid,i.nickname=n.nickname,i.resetX=n.resetX,i.resetY=n.resetY,i.bulletY=n.bulletY,i.rotation=n.rotation,i.randVelocity=n.randVelocity,bullets[i.session]=i,io.sockets.in(o).emit("newBullet",bullets[i.session])}),e.on("playerDied",function(e){console.log("Removed dead player: ",e)}),e.on("playerRevive",function(s,o){var n=o;e.broadcast.to(n).emit("playerAlive",s)}),e.on("playerMinion",function(e,s){var o=s;players[e].minion=!0,io.sockets.in(o).emit("minionPlayer",e)}),e.on("newRoom",function(e){if("undefined"!=typeof e){var o=JSON.parse(e),n={};o.address in rooms?(console.log("room bestaat al"),n.name=o.address+"_"+s(5)):n.name=o.address,n.lat=o.lat,n.lng=o.lng,n.players=io.sockets.clients(o.address).length,n.max=maxPlayers,rooms[n.name]=n,io.sockets.emit("roomUpdate",rooms)}}),e.on("joinRoom",function(s){if(io.sockets.clients(s).length<maxPlayers){if(e.session=e.id,e.join(s),io.sockets.socket(e.id).emit("joinedRoom",s),io.sockets.clients(s).length===maxPlayers){console.log("Max Players in room, START GAME");var o=Math.floor(Math.random()*io.sockets.clients(s).length),n=io.sockets.clients(s)[o].session;io.sockets.in(s).emit("startGame",!0,n)}rooms[s].players=io.sockets.clients(s).length,io.sockets.emit("roomUpdate",rooms)}else io.sockets.socket(e.id).emit("roomFull")}),e.on("skin",function(s){skins[e.id]=s}),e.on("tint",function(s){console.log(s),tints[e.id]=s}),e.on("disconnect",function(){delete players[e.id],e.broadcast.emit("removePlayer",e.id)})});