function preload(){game.load.image("player","assets/img/spr_myplane.png"),game.load.image("otherPlayers","assets/img/spr_plane.png"),game.load.image("boss","assets/img/spr_boss.png"),game.load.image("bullet","assets/img/spr_bullet.png"),game.load.image("muzzleFlash","assets/img/spr_muzzleFlash.png"),game.load.spritesheet("mainBg","assets/img/spr_backgroundOverlay.png",160,160),game.load.image("cloud1","assets/img/spr_cloud1.png"),game.load.image("cloud2","assets/img/spr_cloud2.png"),game.load.image("moon","assets/img/spr_moon.png"),game.load.audio("backgroundMusic",["assets/audio/TakingFlight.mp3","assets/audio/TakingFlight.ogg"])}function create(){for(this.stage.disableVisibilityChange=!0,game.renderer.clearBeforeRender=!1,game.renderer.roundPixels=!0,game.physics.startSystem(Phaser.Physics.ARCADE),game.world.setBounds(0,0,2e3,2e3),bgtile=game.add.tileSprite(0,0,2e3,2e3,"mainBg"),clouds=game.add.group(),clouds.enableBody=!0,clouds.physicsBodyType=Phaser.Physics.ARCADE,clouds.setAll("anchor.x",.5),clouds.setAll("anchor.y",.5),clouds.setAll("outOfBoundsKill",!0),i=0;5>i;i++)createCloud();createMoon(),game.scale.fullScreenScaleMode=Phaser.ScaleManager.NO_SCALE,game.input.onDown.add(goFullscreen,this),window.addEventListener("resize",function(){resizeGame(),console.log("window has been resized!")}),playerName=prompt("What's your battle name?"),console.log(currentDate()+" | Welcome: "+playerName.charAt(0).toUpperCase()+playerName.substring(1)+"."),backgroundMusic=game.add.audio("backgroundMusic"),playerGroup=game.add.group(),player=game.add.sprite(game.world.centerX,game.world.centerY,"player"),player.anchor.setTo(.5,.5),game.physics.enable(player,Phaser.Physics.ARCADE),player.enableBody=!0,player.body.collideWorldBounds=!0,player.bringToTop(),playerGroup.add(player),game.camera.follow(player),textPlayer=game.add.text(game.world.centerX,50,"Player: "+playerName),textPlayer.font="Press Start 2P",textPlayer.fontSize=15,textPlayer.fill="#f00",textPlayer.align="center",textPlayer.anchor.setTo(.5,.5),textPlayer.fixedToCamera=!0,textBullets=game.add.text(window.screen.availWidth-150,50,"Bullets: "+bulletsCount),textBullets.font="Press Start 2P",textBullets.fontSize=15,textBullets.fill="#f00",textBullets.align="left",textBullets.anchor.setTo(.5,.5),textBullets.fixedToCamera=!0,textOnlinePlayers=game.add.text(180,0+window.screen.availHeight-200,"Online Players:\nYou ("+playerName+")"),textOnlinePlayers.font="Press Start 2P",textOnlinePlayers.fontSize=15,textOnlinePlayers.fill="#f00",textOnlinePlayers.align="left",textOnlinePlayers.anchor.setTo(.5,.5),textOnlinePlayers.fixedToCamera=!0,socket.emit("requestPlayers",io.socket.sessionid),socket.on("onlinePlayer",function(e){for(var a in e)newPlayer(e[a]),onlinePlayers.push(e[a].nickname);textOnlinePlayers.setText("Online Players:\nYou ("+playerName+")\n"+onlinePlayers.join("\n"))});var e=JSON.stringify({sessionid:io.socket.sessionid,nickname:playerName,x:game.world.centerX,y:game.world.centerY});socket.emit("newPlayer",e),socket.on("sendNewPlayer",function(e){console.log(currentDate()+" | Player: "+e.nickname.charAt(0).toUpperCase()+e.nickname.substring(1)+" has joined the game!"),newPlayer(e),onlinePlayers.push(e.nickname),textOnlinePlayers.setText("Online Players:\nYou ("+playerName+")\n"+onlinePlayers.join("\n"))}),socket.on("updatePlayer",function(e){updatePlayer(e)}),socket.on("removePlayer",function(e){console.log("remove",e),removePlayer(e);var a=onlinePlayers.indexOf(players[e].name);-1!=a&&onlinePlayers.splice(a,1),textOnlinePlayers.setText("Online Players:\nYou ("+playerName+")\n"+onlinePlayers.join("\n"))}),socket.on("newBullet",function(e){newBullet(e)}),boss=game.add.sprite(100,200,"boss"),boss.anchor.setTo(.5,.5),boss.enableBody=!0,game.physics.enable(boss,Phaser.Physics.ARCADE),boss.physicsBodyType=Phaser.Physics.ARCADE,boss.health=1e3,bullets=game.add.group(),bullets.enableBody=!0,bullets.physicsBodyType=Phaser.Physics.ARCADE,bullets.createMultiple(bulletsCount,"bullet"),bullets.setAll("static",!0),bullets.setAll("anchor.x",.5),bullets.setAll("anchor.y",1),bullets.setAll("outOfBoundsKill",!0),otherBullets=game.add.group(),otherBullets.enableBody=!0,otherBullets.physicsBodyType=Phaser.Physics.ARCADE,otherBullets.setAll("anchor.x",.5),otherBullets.setAll("anchor.y",.5),otherBullets.setAll("outOfBoundsKill",!0),muzzleFlash=game.add.group(),muzzleFlash.createMultiple(30,"muzzleFlash"),game.input.addPointer(),fireButton=game.input.pointer1,game.device.desktop?cursors=game.input.keyboard.createCursorKeys():(navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate||null,vibrate=navigator.vibrate?!0:!1,gyro.hasFeature("devicemotion")?(console.log(currentDate()+" | Gyro.js loaded!"),gyro.getFeatures().length>0&&(gyro.frequency=10,gyro.startTracking(function(e){var a=Math.atan2(e.y,e.x);angleRadians=a*Math.PI/180,a*=180/Math.PI,a=180-a,fireButton.isDown&&fire(),e.z<9.5||e.z>10?changePosition("-",20*e.x,"+",20*e.y,game.math.wrapAngle(a,!1)):changePosition("","","","",0)}))):(console.log(currentDate()+" | Gyro.js not loaded!"),window.addEventListener("devicemotion",function(e){var a=e.accelerationIncludingGravity.x,o=e.accelerationIncludingGravity.y,t=e.accelerationIncludingGravity.z,l=Math.atan2(o,a);l*=180/Math.PI,l=180-l,fireButton.isDown&&fire(),9.5>t||t>10?changePosition("-",40*a,"+",40*o,game.math.wrapAngle(l,!1)):changePosition("","","","",0)})))}function update(){if(player.body.velocity.setTo(0,0),bgtile.tilePosition.x-=1,bgtile.tilePosition.y+=.5,game.time.now>cloudTimer&&createCloud(),moon.x>game.world.width+moon.width&&(moon.destroy(),createMoon()),document.hasFocus()?1==game.sound.mute&&(game.sound.mute=!1):0==game.sound.mute&&(game.sound.mute=!0),game.device.desktop){cursors.left.isDown?cursors.left.isDown&&cursors.down.isDown?changePosition("-",diagonalSpeed(movementSpeed),"+",diagonalSpeed(movementSpeed),135):cursors.left.isDown&&cursors.up.isDown?changePosition("-",diagonalSpeed(movementSpeed),"-",diagonalSpeed(movementSpeed),-135):changePosition("-",movementSpeed,"","",180):cursors.right.isDown?cursors.right.isDown&&cursors.down.isDown?changePosition("+",diagonalSpeed(movementSpeed),"+",diagonalSpeed(movementSpeed),45):cursors.right.isDown&&cursors.up.isDown?changePosition("+",diagonalSpeed(movementSpeed),"-",diagonalSpeed(movementSpeed),-45):changePosition("+",movementSpeed,"","",0):cursors.up.isDown?changePosition("","","-",movementSpeed,-90):cursors.down.isDown&&changePosition("","","+",movementSpeed,90),game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR).isDown&&fire(),game.physics.arcade.overlap(bullets,boss,bulletCollisionWithBoss,null,this);for(var e in players)game.physics.arcade.overlap(bullets,players[e],bulletCollisionWithPlayer,null,this);game.physics.arcade.overlap(otherBullets,boss,otherBulletCollisionWithBoss,null,this)}if(shakeScreen>0){var a=game.rnd.integerInRange(-5,5),o=game.rnd.integerInRange(-5,5);game.world.setBounds(a,o,2e3+a,2e3+o),shakeScreen--,0==shakeScreen&&game.world.setBounds(0,0,2e3,2e3)}}function fire(){if(game.time.now>bulletTime&&(bullet=bullets.getFirstExists(!1))){0==player.angle||-90==player.angle?bullet.reset(player.body.x+38,player.body.y+38):bullet.reset(player.body.x+26,player.body.y+26),bullet.rotation=player.rotation,game.physics.arcade.velocityFromRotation(player.rotation,400,bullet.body.velocity),bulletTime=game.time.now+150,1==vibrate&&navigator.vibrate(500),shakeScreen=15,bulletsCount--,textBullets.setText("Bullets: "+bulletsCount);var e=JSON.stringify({sessionid:io.socket.sessionid,rotation:bullet.rotation,nickname:playerName,x:bullet.x,y:bullet.y});socket.emit("bulletChange",e)}}function newPlayer(e){e.session,e.nickname,e.x,e.y;players[e.session]=game.add.sprite(e.x,e.y,"otherPlayers"),players[e.session].anchor.setTo(.5,.5),game.physics.enable(players[e.session],Phaser.Physics.ARCADE),players[e.session].enableBody=!0,players[e.session].body.collideWorldBounds=!0,players[e.session].name=e.session,players[e.session].health=100,playerGroup.add(players[e.session])}function updatePlayer(e){e.session,e.nickname,e.x,e.y,e.angle;players[e.session].x=e.x,players[e.session].y=e.y,players[e.session].angle=e.angle}function removePlayer(e){var a=e;players[a].kill()}function newBullet(e){otherBullets.createMultiple(1,"bullet"),otherBullet=otherBullets.getFirstExists(!1),otherBullet&&(otherBullet.reset(e.x,e.y),otherBullet.rotation=e.rotation,game.physics.arcade.velocityFromRotation(e.rotation,400,otherBullet.body.velocity))}function changePosition(e,a,o,t,l){if(""==a?a=0:a,""==t?t=0:t,"+"==e?player.body.velocity.x+=a:"-"==e?player.body.velocity.x-=a:player.body.velocity.x+=0,"+"==o?player.body.velocity.y+=t:"-"==o?player.body.velocity.y-=t:player.body.velocity.y+=0,player.angle=l,oldX!==player.x||oldY!==player.y){var n=JSON.stringify({sessionid:io.socket.sessionid,nickname:playerName,x:player.x,y:player.y,angle:player.angle});(diffNumbers(player.x,oldX)>=1||diffNumbers(player.y,oldY)>=1)&&(socket.emit("positionChange",n),oldX=player.x,oldY=player.y)}}function bulletCollisionWithBoss(){bullet.destroy(),boss.damage(100)}function otherBulletCollisionWithBoss(){otherBullet.destroy(),boss.damage(100)}function bulletCollisionWithPlayer(e){bullet.destroy(),players[e.name].damage(10),0==players[e.name].health&&alert("You have killed player: "+players[e.name].name+"!")}function diagonalSpeed(e){var a=Math.sqrt(2*Math.pow(e,2))/2;return a}function createCloud(){var e=Math.floor(10*Math.random()+1),a=Math.floor(401*Math.random())+400;if(5>e)var o=game.add.sprite(-(Math.random()*a),game.world.randomY,"cloud1");else var o=game.add.sprite(-(Math.random()*a),game.world.randomY,"cloud2");o.angle=game.rnd.angle(),game.add.tween(o).to({x:game.width+(1600+o.x)},15e4,Phaser.Easing.Linear.None,!0),game.add.tween(o).to({angle:o.angle},15e4,Phaser.Easing.Linear.None,!0),cloudTimer=game.time.now+5e3,clouds.add(o)}function createMoon(){var e=game.world.randomY;300>e?e+=164:e>1700?e-=164:e=e,console.log(e),moon=game.add.sprite(-(400*Math.random()),e,"moon"),moon.angle=game.rnd.angle(),game.add.tween(moon).to({x:game.width+(1600+moon.x)},3e5,Phaser.Easing.Linear.None,!0)}function randName(){for(var e="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;10>o;o++)e+=a.charAt(Math.floor(Math.random()*a.length));return e}function diffNumbers(e,a){return Math.abs(e-a)}function currentDate(){var e=new Date,a=1==e.getMinutes().toString().length?"0"+e.getMinutes():e.getMinutes(),o=1==e.getSeconds().toString().length?"0"+e.getSeconds():e.getSeconds(),t=1==e.getHours().toString().length?"0"+e.getHours():e.getHours();return e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear()+" "+t+":"+a+":"+o}function goFullscreen(){}function resizeGame(){var e=window.innerWidth*window.devicePixelRatio,a=window.innerHeight*window.devicePixelRatio;game.width=e,game.height=a,game.stage.width=e,game.stage.height=a,game.scale.width=e,game.scale.height=a,game.renderType===Phaser.WEBGL?game.renderer.resize(e,a):game.renderType===Phaser.CANVAS&&(game.renderer.resize(e,a),Phaser.Canvas.setSmoothingEnabled(game.context,!1)),game.scale.setSize()}function render(){}var w=window.innerWidth*window.devicePixelRatio,h=window.innerHeight*window.devicePixelRatio,game=new Phaser.Game(w,h,Phaser.AUTO,"",{preload:preload,create:create,update:update,render:render}),io=io.connect("",{rememberTransport:!1,transports:["WebSocket","Flash Socket","AJAX long-polling"]}),player,boss,players={},playerName,onlinePlayers=[],cursors,fireButton,bullets,bulletTime=0,textBullets,textPlayer,bulletsCount=100,oldX=0,oldY=0,otherBullets,movementSpeed=350,diagonalSpeed,vibrate=!1,shakeScreen=0,bossHealth=100,muzzleFlash,playerGroup,bgtile,clouds,cloudTimer=0,moon,playerBullet,backgroundMusic;