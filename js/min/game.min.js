var io=io.connect("",{rememberTransport:!1,transports:["WebSocket","Flash Socket","AJAX long-polling"]}),player,boss,players={},coopPlayers={},playerName,onlinePlayers=[],cursors,fireButton,bullets,currentDirection,bulletsCount=20,bulletTime=0,textPlayers,curPlayerFrame,textScore,oldX=0,oldY=0,movementSpeed=350,diagonalSpeed,vibrate=!1,shakeScreen=0,bossHealth=100,muzzleFlash,playerType,bossIsDying=!1,playerGroup,bgtile,clouds,radarCursor,mergeIcon,radarMeters,cloudTimer=0,stars,starTimer=0,moon,playerBullet,backgroundMusic,shipHitSound,range=100,coop,coopMovement=!1,coopShooting=!1,logging=!0,bounds=2e3,friendlyFire=!0,deadTimer,revived=0,minionTime=5;SpaceBattalion.Game=function(){this.game,this.add,this.camera,this.debug,this.cache,this.input,this.load,this.math,this.sound,this.stage,this.time,this.tweens,this.state,this.world,this.particles,this.physics,this.renderer,this.rnd},SpaceBattalion.Game.prototype={create:function(){window.boss===io.socket.sessionid&&console.log("ik ben de boss");var e=JSON.stringify({sessionid:io.socket.sessionid,lat:window.lat,"long":window.lng});socket.emit("locationUpdate",e,myRoom),this.stage.disableVisibilityChange=!0,this.time.advancedTiming=!0,this.input.maxPointers=1,console.log("je huidige room is: "+myRoom),logging||(console.log=function(){}),"undefined"==typeof console&&(console={}),this.physics.startSystem(Phaser.Physics.ARCADE),this.world.setBounds(0,0,bounds,bounds),this.backgroundMusic=this.add.audio("backgroundMusic"),SpaceBattalion.music,this.shipHitSound=this.add.audio("shipHitSound"),this.laserShotSound=this.add.audio("laserShotSound"),this.explosionSound=this.add.audio("explosionSound"),playerName=window.inlognaam,bgtile=this.add.tileSprite(0,0,bounds,bounds,"mainBg"),player=this.add.sprite(this.world.centerX,this.world.centerY,window.skin),boss=this.add.sprite(100,200,"boss"),playerType="boss"===playerName?boss:player,this.getLocation(),player.anchor.setTo(.5,.5),player.name=io.socket.sessionid,player.allowControls=!0,player.coop=!1,player.move=!0,player.shoot=!0,player.health=100,player.bringToTop(),this.physics.enable(player,Phaser.Physics.ARCADE),player.physicsBodyType=Phaser.Physics.ARCADE,player.enableBody=!0,player.body.collideWorldBounds=!0,player.body.immovable=!0,player.score=0,player.frame=3,player.minion=!1,"undefined"!=typeof window.tint&&0!==window.tint&&(player.tint=window.tint),player.lat=window.lat,player.lng=window.lng,playerGroup=this.add.group(),playerGroup.add(player),playerGroup.bringToTop(player),mergeIcon=this.add.sprite(this.world.centerX,this.world.centerY,"mergeButton"),mergeIcon.fixedToCamera=!0,mergeIcon.cameraOffset.setTo(200,200),mergeIcon.visible=!1,boss.anchor.setTo(.5,.5),boss.allowControls=!0,boss.enableBody=!0,this.physics.enable(boss,Phaser.Physics.ARCADE),boss.physicsBodyType=Phaser.Physics.ARCADE,boss.health=1e3,boss.frame=1,boss.body.immovable=!0,boss.move=!1,this.camera.follow(playerType,Phaser.Camera.FOLLOW_TOPDOWN),bullets=this.add.group();for(var o=0;bulletsCount>o;o++){var s=this.add.sprite(0,0,"bullet");bullets.add(s),s.animations.add("bulletCollide",[1,2,3,4,5,6]),s.anchor.setTo(.5,.5),s.frame=0,this.physics.enable(s,Phaser.Physics.ARCADE),s.kill()}socket.emit("requestPlayers",io.socket.sessionid,myRoom);var a=this;socket.on("onlinePlayer",function(e){console.log(e),0===Object.getOwnPropertyNames(e).length?console.log("There are no other players online."):(console.log("There are other players online."),socket.emit("getCoopPlayers",io.socket.sessionid));for(var o in e)e[o].session.length<=20&&(console.log("Creating player",e[o].session),console.log(e[o]),a.createPlayer(e[o])),onlinePlayers.push(e[o].session)});var a=this;socket.on("onlineCoop",function(e){for(var o in e){var s=e[o].player1,r=e[o].player2,i=e[o].shoot,l=e[o].move,t=e[o].session,n=e[o].x,p=e[o].y,y=e[o].angle;s!==io.socket.sessionid&&r!==io.socket.sessionid&&(console.log("Creating new Co-op (other players)"),a.createCoop(r,s,i,l,t,n,p,y,"other"))}});var r=JSON.stringify({sessionid:io.socket.sessionid,nickname:playerName,x:this.world.centerX,y:this.world.centerY,lat:player.lat,"long":player.lng,angle:0});socket.emit("newPlayer",r,myRoom);var a=this;socket.on("sendNewPlayer",function(e){e.session!==io.socket.sessionid&&(a.createPlayer(e),onlinePlayers.push(e.session))});var a=this;socket.on("joinCoop",function(e){var o=JSON.parse(e),s=o.player1,r=o.player2,i=o.move,l=o.shoot;a.createCoop(s,r,i,l,"","","","join")});var a=this;socket.on("updatePlayer",function(e){a.updatePlayer(e)});var a=this;socket.on("removePlayer",function(e){a.removePlayer(e);var o=onlinePlayers.indexOf(players[e].name);-1!=o&&onlinePlayers.splice(o,1)});var a=this;socket.on("newBullet",function(e){a.createBullet(e)});var a=this;socket.on("playerShot",function(e){if(SpaceBattalion.music&&a.shipHitSound.play(),e===io.socket.sessionid)if(player.damage(10),console.log("ik wordt gehit"),player.minion===!1)if(player.health<=70&&player.health>30)player.frame=10,setTimeout(function(){player.frame=4},100);else if(player.health<=30&&player.health>0)player.frame=10,setTimeout(function(){player.frame=5},100);else if(player.health<=0)player.frame=10,setTimeout(function(){player.frame=9},100),player.alive=!0,player.exists=!0,player.visible=!0,player.allowControls=!1,socket.emit("playerDied",io.socket.sessionid),0===revived?(deadTimer=game.time.create(!1),deadTimer.add(1e3*minionTime,function(){console.log("player dood, starten van timer.."),a.explode(player.x,player.y),socket.emit("playerMinion",io.socket.sessionid,myRoom)},this),deadTimer.start()):socket.emit("playerMinion",io.socket.sessionid,myRoom);else{var o=player.frame;player.frame=10,setTimeout(function(){player.frame=o},100)}else player.frame=11,setTimeout(function(){player.frame=12},100);else if(e.length>20){coopPlayers[e].damage(10);var s=coopPlayers[e].frame;coopPlayers[e].frame=0,setTimeout(function(){coopPlayers[e].frame=s},100),0===coopPlayers[e].health}else{players[e].damage(10);var r=a.distance(player.lat,player.lng,players[e].lat,players[e].lng,"M");if(players[e].minion===!1)if(players[e].health<=70&&players[e].health>30)players[e].frame=10,range>=r?setTimeout(function(){players[e].frame=7},100):setTimeout(function(){players[e].frame=1},100);else if(players[e].health<=30&&players[e].health>0)players[e].frame=10,range>=r?setTimeout(function(){players[e].frame=8},100):setTimeout(function(){players[e].frame=2},100);else if(players[e].health<=0)players[e].frame=10,setTimeout(function(){players[e].frame=9},100),players[e].alive=!0,players[e].exists=!0,players[e].visible=!0,setTimeout(function(){a.explode(players[e].x,players[e].y)},1e3);else{var o=players[e].frame;players[e].frame=10,setTimeout(function(){players[e].frame=o},100)}else players[e].frame=11,setTimeout(function(){players[e].frame=13},100)}});var a=this;socket.on("playerAlive",function(e){players[e].revive();var o=a.distance(player.lat,player.lng,players[e].lat,players[e].lng,"M");players[e].frame=range>=o?6:0,players[e].health=100,players[e].alive=!0}),socket.on("minionPlayer",function(e){e===io.socket.sessionid?(player.revive(),player.frame=12,player.minion=!0,player.health=100,player.allowControls=!0):(players[e].revive(),players[e].frame=13,players[e].minion=!0,players[e].health=100,players[e].allowControls=!0)});var a=this;socket.on("bossDead",function(){a.explode(boss.x,boss.y),player.score+=1e3,console.log("Total score: "+player.score),$.ajax({type:"post",url:"http://buitmediasolutions.nl/spacebattalion/score.php",data:{id:window.playerObject.id,score:player.score},success:function(e){console.log(e)}}),setTimeout(function(){a.shutdown()},500)});var a=this;if(socket.on("updatedLocation",function(e){console.log("updating position"),players[e.session].lat=e.lat,players[e.session].lng=e.long;var o=a.distance(player.lat,player.lng,players[e.session].lat,players[e.session].lng,"M");range>=o&&(""==radarCursor||null==radarCursor||"undefined"==typeof radarCursor?(radarCursor=a.add.sprite(0,0,"radarCursor"),radarCursor.anchor.setTo(.5,.5),radarCursor.fixedToCamera=!0,radarCursor.cameraOffset.setTo(cursorOffsetX,100),radarMeters=a.add.text(0,0,o.toFixed(2)+" M",{font:"14px Arial",fill:"#ffffff",align:"center"}),radarMeters.fixedToCamera=!0,radarMeters.cameraOffset.setTo(cursorOffsetX-15,140),players[e.session].frame=6,cursorOffsetX+=60):radarMeters.setText(o.toFixed(2)+" M"))}),this.game.device.desktop){for(cursors=this.input.keyboard.createCursorKeys(),clouds=this.add.group(),clouds.enableBody=!0,clouds.physicsBodyType=Phaser.Physics.ARCADE,clouds.setAll("anchor.x",.5),clouds.setAll("anchor.y",.5),clouds.setAll("outOfBoundsKill",!0),o=0;5>o;o++)this.createCloud();stars=this.add.group(),stars.enableBody=!0,stars.physicsBodyType=Phaser.Physics.ARCADE,stars.setAll("anchor.x",.5),stars.setAll("anchor.y",.5),stars.setAll("outOfBoundsKill",!0),this.createMoon()}else{$(".logo, .payoff").css("display","none"),this.camera.setSize(500,500),navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate||null,vibrate=navigator.vibrate?!0:!1;var a=this;gyro.hasFeature("devicemotion")&&(console.log("Gyro.js loaded!"),gyro.getFeatures().length>0&&(gyro.frequency=10,gyro.startTracking(function(e){var o=Math.atan2(e.y,e.x);angleRadians=o*Math.PI/180,o*=180/Math.PI,o-=90,o=a.math.wrapAngle(-o),player.allowControls===!0&&(e.z<9.5||e.z>10?a.changePosition("+",50*e.y,"+",50*e.x,o,"p"):a.changePosition("+",0,"+",0,playerType.angle,"p"))})))}},update:function(){var e=this;window.onblur=function(){e.backgroundMusic.pause()};var e=this;if(window.onfocus=function(){e.backgroundMusic.resume()},0!==Object.getOwnPropertyNames(coopPlayers).length?Object.keys(coopPlayers).forEach(function(e){e.indexOf(io.socket.sessionid)>-1?coopPlayers[e].body.velocity.setTo(0,0):playerType.body.velocity.setTo(0,0)}):playerType===boss?playerType.body.velocity.setTo(0,0):"undefined"!=typeof player&&player.body.velocity.setTo(0,0),this.game.device.desktop){if(bgtile.tilePosition.x-=2,bgtile.tilePosition.y+=1,clouds.length>=30?(console.log("meer dan 30 wolken.. "),clouds.removeAll()):this.time.now>cloudTimer&&this.createCloud(),stars.length>=40?(console.log("meer dan 40 sterren.. "),stars.removeAll()):this.time.now>starTimer&&this.createStar(),moon.x>this.world.width+moon.width&&(moon.destroy(),this.createMoon()),"undefined"!=typeof player&&player.visible===!0&&player.coop===!1){var o="p";movementSpeed=350}else{var o="c";movementSpeed=175}("undefined"!=typeof player&&player.move===!0&&player.allowControls===!0||coopMovement===!0)&&(Object.keys(coopPlayers).forEach(function(e){e.indexOf(io.socket.sessionid)>-1&&(o=e)}),cursors.left.isDown?cursors.left.isDown&&cursors.down.isDown?(this.changePosition("-",this.diagonalSpeed(movementSpeed),"+",this.diagonalSpeed(movementSpeed),135,o),currentDirection="left-down"):cursors.left.isDown&&cursors.up.isDown?(this.changePosition("-",this.diagonalSpeed(movementSpeed),"-",this.diagonalSpeed(movementSpeed),-135,o),currentDirection="left-up"):(this.changePosition("-",movementSpeed,"","",180,o),currentDirection="left"):cursors.right.isDown?cursors.right.isDown&&cursors.down.isDown?(this.changePosition("+",this.diagonalSpeed(movementSpeed),"+",this.diagonalSpeed(movementSpeed),45,o),currentDirection="right-down"):cursors.right.isDown&&cursors.up.isDown?(this.changePosition("+",this.diagonalSpeed(movementSpeed),"-",this.diagonalSpeed(movementSpeed),-45,o),currentDirection="right-up"):(this.changePosition("+",movementSpeed,"","",0,o),currentDirection="right"):cursors.up.isDown?(this.changePosition("","","-",movementSpeed,-90,o),currentDirection="up"):cursors.down.isDown&&(this.changePosition("","","+",movementSpeed,90,o),currentDirection="down")),("undefined"!=typeof player&&player.shoot===!0||coopShooting===!0)&&this.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR).isDown&&(this.fire(null),console.log("aaa"))}else this.input.onTap.add(this.tapScreen,this);for(var s in players){if(players[s].visible!==!1&&1==friendlyFire&&players[s].health>0&&this.physics.arcade.collide(bullets,players[s],this.bulletOtherPlayer,null,this),player.visible!==!1&&1==friendlyFire&&player.health>0&&this.physics.arcade.collide(bullets,player,this.bulletPlayer,null,this),"undefined"!=typeof player.lat&&"undefined"!=typeof player.lng){var a=this.distance(player.lat,player.lng,players[s].lat,players[s].lng,"M");range>=a&&this.physics.arcade.distanceBetween(players[s],player)<range&&player.minion===!1&&players[s].minion===!1&&players[s].health>0&&player.health>0&&player.coop===!1&&players[s].coop===!1?(mergeIcon.visible=!0,mergeIcon.inputEnabled=!0,mergeIcon.events.onInputDown.add(this.mergePlayers,this)):mergeIcon.visible=!1}0===player.health&&player.minion===!1&&0===revived&&this.physics.arcade.overlap(players[s],player,this.revivePlayer,null,this)}for(var s in coopPlayers&&1==friendlyFire)this.physics.arcade.collide(bullets,coopPlayers[s],this.bulletCoop,null,this);this.physics.arcade.collide(bullets,boss,this.bulletBoss,null,this),this.physics.arcade.overlap(player,boss,this.overlapPlayer,null,this)},createPlayer:function(e){e.session,e.nickname,e.x,e.y,e.angle;players[e.session]=this.add.sprite(e.x,e.y,"player"),players[e.session].anchor.setTo(.5,.5),this.physics.enable(players[e.session],Phaser.Physics.ARCADE),players[e.session].enableBody=!0,players[e.session].body.collideWorldBounds=!0,players[e.session].name=e.session,players[e.session].health=100,players[e.session].minion=!1,players[e.session].angle=e.angle,players[e.session].body.immovable=!0,"undefined"!=typeof e.minion&&(e.minion===!0?(players[e.session].minion=!0,players[e.session].frame=13):(players[e.session].minion=!1,players[e.session].frame=0)),players[e.session].lat=e.lat,players[e.session].lng=e.long,console.log("new player pos",players[e.session].lat,players[e.session].lng),"ns"==e.skin?players[e.session].loadTexture("ns"):"wk"==e.skin&&players[e.session].loadTexture("wk"),0!==e.tint&&(players[e.session].tint=e.tint),players[e.session].coop=!1,players[e.session].coopPlayer="","undefined"!=typeof e.coop&&e.coop===!0&&(players[e.session].visible=!1),playerGroup.add(players[e.session]),playerGroup.bringToTop(player);var o=400;if(0!==player.lat&&0!==player.lng&&0!==players[e.session].lat&&0!==players[e.session].lng){var s=this.distance(player.lat,player.lng,players[e.session].lat,players[e.session].lng,"M");console.log("distance tussen mijzelf en andere: "+s),range>=s?(console.log("dist",s,"kleiner dan",range),""==radarCursor||null==radarCursor||"undefined"==typeof radarCursor?(radarCursor=this.add.sprite(0,0,"radarCursor"),radarCursor.anchor.setTo(.5,.5),radarCursor.fixedToCamera=!0,radarCursor.cameraOffset.setTo(o,100),radarMeters=this.add.text(0,0,s.toFixed(2)+" M",{font:"14px Arial",fill:"#ffffff",align:"center"}),radarMeters.fixedToCamera=!0,radarMeters.cameraOffset.setTo(o-15,140),players[e.session].frame=6,o+=60):radarMeters.setText(s.toFixed(2)+" M")):console.log("dist",s," groter dan ",range)}else console.log("1 van deze waardes zijn 0 of undefined"),console.log(player.lat,player.lng,players[e.session].lat,players[e.session].lng)},createCoop:function(e,o,s,a,r,i,l,t){if(coopSession="new"==t?e+o:o+e,(e===io.socket.sessionid||o===io.socket.sessionid)&&(player.coop=!0),coopPlayers[coopSession]=this.add.sprite(this.world.centerX,this.world.centerY,"coop"),coopPlayers[coopSession].name=coopSession,coopPlayers[coopSession].player1=e,coopPlayers[coopSession].player2=o,coopPlayers[coopSession].coopSession=coopSession,coopPlayers[coopSession].move=a,coopPlayers[coopSession].shoot=s,coopPlayers[coopSession].anchor.setTo(.5,.5),coopPlayers[coopSession].enableBody=!0,this.physics.enable(coopPlayers[coopSession],Phaser.Physics.ARCADE),coopPlayers[coopSession].physicsBodyType=Phaser.Physics.ARCADE,coopPlayers[coopSession].health=250,coopPlayers[coopSession].frame=3,coopPlayers[coopSession].body.collideWorldBounds=!0,coopPlayers[coopSession].body.immovable=!0,""!==r&&""!==i&&""!==l&&(coopPlayers[coopSession].x=r,coopPlayers[coopSession].y=i,coopPlayers[coopSession].angle=l),coopPlayers[coopSession].move==io.socket.sessionid&&(coopPlayers[coopSession].frame=2,coopMovement=!0,coopShooting=!1),coopPlayers[coopSession].shoot==io.socket.sessionid&&(coopPlayers[coopSession].frame=1,coopShooting=!0,coopMovement=!1,player.move=!1),e===io.socket.sessionid?("undefined"!=typeof player&&(player.coop=!0,player.visible=!1,player.renderable=!1,player.allowControls=!1,player.move=!1,player.shoot=!1,player.enableBody=!1),"undefined"!=typeof players[o]&&(players[o].visible=!1,players[o].coop=!0,players[o].renderable=!1,players[o].enableBody=!1),this.camera.follow(coopPlayers[coopSession],Phaser.Camera.FOLLOW_TOPDOWN)):o===io.socket.sessionid?("undefined"!=typeof player&&(player.coop=!0,player.visible=!1,player.renderable=!1,player.allowControls=!1,player.move=!1,player.shoot=!1,player.enableBody=!1),"undefined"!=typeof players[e]&&(players[e].visible=!1,players[e].coop=!0,players[e].renderable=!1,players[e].enableBody=!1),this.camera.follow(coopPlayers[coopSession],Phaser.Camera.FOLLOW_TOPDOWN)):("undefined"!=typeof players[e]&&(players[e].visible=!1,players[e].coop=!0,players[e].renderable=!1,players[e].enableBody=!1),"undefined"!=typeof players[o]&&(players[o].visible=!1,players[o].coop=!0,players[o].renderable=!1,players[o].enableBody=!1)),"new"===t){var n=JSON.stringify({player1:o,player2:e,move:o,shoot:e,x:coopPlayers[coopSession].x,y:coopPlayers[coopSession].y,angle:coopPlayers[coopSession].angle});socket.emit("newCoop",n,myRoom)}},updatePlayer:function(e){"boss"===e.nickname?(boss.x=e.x,boss.y=e.y,boss.angle=e.angle):"coop"===e.nickname?(coopPlayers[e.session].x=e.x,coopPlayers[e.session].y=e.y,coopPlayers[e.session].angle=e.angle):(players[e.session].x=e.x,players[e.session].y=e.y,players[e.session].angle=e.angle)},fire:function(e){if(this.time.now>bulletTime){if(bulletTime=this.time.now+250,player.coop===!0)var o=coopPlayers[coopSession].body.x+coopPlayers[coopSession].width/2,s=coopPlayers[coopSession].body.y+coopPlayers[coopSession].height/2,a=coopPlayers[coopSession].rotation,r=-0.2*Math.random()+.1,i=Math.floor(40*Math.random()+-20);else{if("left"===e)var o=playerType.body.x+.25*playerType.width,s=playerType.body.y+.25*playerType.height,r=0,i=0;else if("right"===e)var o=playerType.body.x+.75*playerType.width,s=playerType.body.y+.75*playerType.height,r=0,i=0;else var o=playerType.body.x+playerType.width/2,s=playerType.body.y+playerType.height/2,r=-0.2*Math.random()+.1,i=Math.floor(40*Math.random()+-20);var a=playerType.rotation}var l=JSON.stringify({sessionid:io.socket.sessionid,rotation:a,nickname:playerName,resetX:o,resetY:s,bulletY:i,randVelocity:r});socket.emit("bulletChange",l,myRoom),SpaceBattalion.music&&this.laserShotSound.play()}},explode:function(e,o){explosion=this.add.sprite(e,o,"explosion"),explosion.anchor.setTo(.5,.5),explosion.alpha=0,this.add.tween(explosion).to({alpha:1},100,Phaser.Easing.Linear.None,!0,0,100,!0),explosion.animations.add("explosion"),explosion.play("explosion","",!1,!0),SpaceBattalion.music&&this.explosionSound.play()},bulletOtherPlayer:function(e,o){o.animations.play("bulletCollide"),o.events.onAnimationComplete.add(function(){player.name==o.session&&(player.score+=10),o.kill()},this),socket.emit("damagePlayer",players[e.name].name,myRoom)},bulletPlayer:function(e,o){o.animations.play("bulletCollide"),o.events.onAnimationComplete.add(function(){o.kill()},this)},bulletCoop:function(e,o){e.animations.play("bulletCollide"),e.events.onAnimationComplete.add(function(){e.kill()},this),socket.emit("damagePlayer",coopPlayers[o.name].name,myRoom)},bulletBoss:function(e,o){if(!bossIsDying){if(o.session===io.socket.sessionid)if(player.minion===!1){player.score+=10;var s=!1}else var s=!0;else if(players[o.session].minion===!1)var s=!1;else var s=!0;if(s===!1){if(boss.damage(100),boss.frame=0,boss.health<=500&&boss.health>200)boss.tint=16750899;else if(boss.health<=200&&boss.health>0)boss.tint=16711680;else if(boss.health<=0){bossIsDying=!0,boss.tint=16777215,boss.alive=!0,boss.visible=!0,boss.exists=!0,boss.animations.add("boss"),boss.animations.play("boss",8,!1,!0);boss.events.onAnimationComplete.add(function(){socket.emit("bossDied",io.socket.sessionid,myRoom)}),player.score+=2e3,console.log("Total score: "+player.score),$.ajax({type:"post",url:"http://buitmediasolutions.nl/spacebattalion/score.php",data:{id:window.playerObject.id,score:player.score},success:function(e){console.log(e)}})}setTimeout(function(){boss.frame=1},100)}}o.animations.play("bulletCollide"),o.events.onAnimationComplete.add(function(){o.kill()},this),SpaceBattalion.music&&this.shipHitSound.play()},overlapPlayer:function(){},mergePlayers:function(){var e=0;if(0==e)for(var o in players)this.physics.arcade.distanceBetween(players[o],player)<=range&&0==e&&(player.coop===!1&&(console.log("Ik ben nog niet in co-op modus"),players[o].coop===!1&&(console.log(players[o].name+" is ook nog niet in co-op modus"),this.createCoop(player.name,players[o].name,players[o].name,player.name,"","","","new"))),e++)},tapScreen:function(e){e.pageX>=0&&e.pageX<=SpaceBattalion.windowWidth/2?this.fire("left"):this.fire("right")},changePosition:function(e,o,s,a,r,i){if("p"===i){if(""==o?o=0:o,""==a?a=0:a,"+"==e?playerType.body.velocity.x+=o:"-"==e?playerType.body.velocity.x-=o:playerType.body.velocity.x+=0,"+"==s?playerType.body.velocity.y+=a:"-"==s?playerType.body.velocity.y-=a:playerType.body.velocity.y+=0,playerType.angle=r,oldX!==playerType.x||oldY!==playerType.y){this.game.device.desktop&&(emitter=this.add.emitter(playerType.x,playerType.y,1),emitter.makeParticles("flyRail"),emitter.setRotation(0,0),emitter.setAlpha(.3,.8),emitter.setScale(.8,3),emitter.gravity=400,emitter.start(!0,150,100)),this.world.bringToTop(playerGroup);var l=JSON.stringify({sessionid:io.socket.sessionid,nickname:playerName,x:playerType.x,y:playerType.y,angle:playerType.angle});(this.diffNumbers(playerType.x,oldX)>=1||this.diffNumbers(playerType.y,oldY)>=1)&&(socket.emit("positionChange",l,myRoom),oldX=playerType.x,oldY=playerType.y)}}else if(""==o?o=0:o,""==a?a=0:a,"+"==e?coopPlayers[i].body.velocity.x+=o:"-"==e?coopPlayers[i].body.velocity.x-=o:coopPlayers[i].body.velocity.x+=0,"+"==s?coopPlayers[i].body.velocity.y+=a:"-"==s?coopPlayers[i].body.velocity.y-=a:coopPlayers[i].body.velocity.y+=0,coopPlayers[i].angle=r,oldX!==coopPlayers[i].x||oldY!==coopPlayers[i].y){var l=JSON.stringify({sessionid:coopSession,nickname:"coop",x:coopPlayers[i].x,y:coopPlayers[i].y,angle:coopPlayers[i].angle});(this.diffNumbers(coopPlayers[i].x,oldX)>=1||this.diffNumbers(coopPlayers[i].y,oldY)>=1)&&(socket.emit("positionChange",l),oldX=coopPlayers[i].x,oldY=coopPlayers[i].y)}},createCloud:function(){var e=Math.floor(10*Math.random()+1);if(5>e)var o=this.add.sprite(this.world.randomX,this.world.randomY,"cloud1");else var o=this.add.sprite(this.world.randomX,this.world.randomY,"cloud2");o.alpha=0,o.angle=this.rnd.angle(),this.add.tween(o).to({alpha:1},2e3,Phaser.Easing.Linear.None).start(),cloudTimer=this.time.now+5e3,clouds.add(o)},createStar:function(){var e=this.add.sprite(this.world.randomX,this.world.randomY,"star");e.alpha=0,e.angle=this.rnd.angle(),this.add.tween(e).to({alpha:1},1e3,Phaser.Easing.Linear.None).start(),starTimer=this.time.now+3e3,stars.add(e)},createMoon:function(){var e=this.world.randomY;300>e?e+=164:e>1700?e-=164:e=e,moon=this.add.sprite(this.world.randomX,e,"moon"),moon.alpha=0,moon.angle=this.rnd.angle(),this.add.tween(moon).to({alpha:1},1e3,Phaser.Easing.Linear.None).to({x:this.game.width+(1600+moon.x)},3e5,Phaser.Easing.Linear.None).to({angle:moon.angle},15e4,Phaser.Easing.Linear.None).start()},removePlayer:function(e){e!==io.socket.sessionid&&(0!==Object.getOwnPropertyNames(coopPlayers).length?Object.keys(coopPlayers).forEach(function(e){e.indexOf(io.socket.sessionid)>-1&&(coopPlayers[e].kill(),player.visible=!0,player.allowControls=!0,player.move=!0,player.shoot=!0,player.enableBody=!0,this.camera.follow(playerType,Phaser.Camera.FOLLOW_TOPDOWN),coopMovement=!1,player.coop=!1,Object.keys(coopPlayers).forEach(function(o){o.indexOf(e)>-1&&delete coopPlayers[e]}))}):players[e].kill())},createBullet:function(e){var o=bullets.getFirstDead();o&&(o.revive(),this.game.device.desktop&&(muzzleFlash=this.add.sprite(e.resetX,e.resetY,"muzzleFlash"),"left"==currentDirection?muzzleFlash.anchor.setTo(1.9,.4):"left-up"==currentDirection?muzzleFlash.anchor.setTo(2.2,2.1):"left-down"==currentDirection?muzzleFlash.anchor.setTo(2.2,-1.4):"right-up"==currentDirection?muzzleFlash.anchor.setTo(-1.2,2.1):"right-down"==currentDirection?muzzleFlash.anchor.setTo(-1.2,-1.2):"right"==currentDirection?muzzleFlash.anchor.setTo(-.9,.6):"down"==currentDirection?muzzleFlash.anchor.setTo(.5,-1):"up"==currentDirection?muzzleFlash.anchor.setTo(.5,1.9):muzzleFlash.anchor.setTo(.5,.5),muzzleFlash.alpha=0,this.add.tween(muzzleFlash).to({alpha:1},100,Phaser.Easing.Linear.None,!0,0,100,!0),muzzleFlash.lifespan=200),o.checkWorldBounds=!0,o.outOfBoundsKill=!0,o.reset(e.resetX,e.resetY),o.rotation=e.rotation,o.y+=e.bulletY,o.session=e.session,this.physics.arcade.velocityFromRotation(e.rotation+=e.randVelocity,625,o.body.velocity),o.animations.add("bulletCollide"),shakeScreen=15)},revivePlayer:function(e,o){console.log("overlap"),deadTimer.stop();this.distance(e.lat,e.lng,o.lat,o.lng,"M");o.frame=3,o.health=100,o.alive=!0,o.allowControls=!0,socket.emit("playerRevive",o.name,myRoom),revived++},diagonalSpeed:function(e){var o=Math.sqrt(2*Math.pow(e,2))/2;return o},compareGPS:function(e,o,s){if(""!==e&&""!==o){var a=this.distance(latitude,longitude,e,o,"M");range>=a&&!isNaN(a)?s!=io.socket.sessionid&&(console.log("Distance between YOU and "+s+" is: "+a.toString()+" meters."),player.coop===!1&&(console.log("Ik ben nog niet in co-op modus"),players[s].coop===!1&&(console.log(s+" is ook nog niet in co-op modus"),this.createCoop(player.name,players[s].name,players[s].name,player.name,"","","","new")))):console.log("Distance between YOU and "+players[s].name+" ("+a+") is greater than the given range ("+range+").")}},getLocation:function(){console.log("getting location"),navigator.geolocation?navigator.geolocation.watchPosition(this.foundPosition,function(e){console.log("OEPS",e.code)},{enableHighAccuracy:!0}):console.log("Het ophalen van uw locatie is mislukt\nGPS wordt niet ondersteund op uw smart device.")},foundPosition:function(e){if(console.log("position lat",e.coords.latitude,"long",e.coords.longitude),e.coords.latitude!==player.lat||e.coords.longitude!==player.lng){player.lat=e.coords.latitude,player.lng=e.coords.longitude;for(var o in players){console.log(players[o]);var s=this.distance(player.lat,player.lng,players[o].lat,players[o].lng,"M");console.log("distance tussen mijzelf en andere: "+s),range>=s?(console.log("dist",s,"kleiner dan",range),""==radarCursor||null==radarCursor||"undefined"==typeof radarCursor?(radarCursor=this.add.sprite(0,0,"radarCursor"),radarCursor.anchor.setTo(.5,.5),radarCursor.fixedToCamera=!0,radarCursor.cameraOffset.setTo(cursorOffsetX,100),radarMeters=this.add.text(0,0,s.toFixed(2)+" M",{font:"14px Arial",fill:"#ffffff",align:"center"}),radarMeters.fixedToCamera=!0,radarMeters.cameraOffset.setTo(cursorOffsetX-15,140),players[o.session].frame=6,cursorOffsetX+=60):radarMeters.setText(s.toFixed(2)+" M")):console.log("dist",s," groter dan ",range)}var a=JSON.stringify({sessionid:io.socket.sessionid,lat:e.coords.latitude,"long":e.coords.longitude});socket.emit("locationUpdate",a,myRoom)}},distance:function(e,o,s,a,r){var i=Math.PI*e/180,l=Math.PI*s/180,t=(Math.PI*o/180,Math.PI*a/180,o-a),n=Math.PI*t/180,p=Math.sin(i)*Math.sin(l)+Math.cos(i)*Math.cos(l)*Math.cos(n);return p=Math.acos(p),p=180*p/Math.PI,p=60*p*1.1515,"K"==r&&(p=1.609344*p),"N"==r&&(p=.8684*p),"M"==r&&(p=1.609344*p*1e3),p},randName:function(){for(var e="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=0;10>s;s++)e+=o.charAt(Math.floor(Math.random()*o.length));return e},diffNumbers:function(e,o){return Math.abs(e-o)},render:function(){this.game.debug.text("FPS: "+this.time.fps,80,150,"rgb(255,255,255)","24px Courier")},shutdown:function(){bgtile.destroy(),clouds.destroy(),stars.destroy(),moon.destroy(),player.destroy(),boss.destroy(),bullets.destroy(),muzzleFlash.destroy(),coopPlayers={},players={},emitter.destroy(),radarCursor.destroy(),radarMeters.destroy(),mergeIcon.destroy(),playerType.destroy(),window.location.href="index.html"}};